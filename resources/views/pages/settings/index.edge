@app({ title: 'Param√®tres IA - My Professor' })
@slot('main')
    <script>
      const settingsConfig = {
        initialProvider: '{{ user.aiProvider || 'default' }}',
        initialUsePersonal: {{ user.useCustomKeys ? 'true' : 'false' }},
        initialCloudModels: {{{ JSON.stringify(cloudModels) }}},
        initialModel: '{{ user.aiModel || '' }}',
        csrfToken: '{{ csrfToken }}'
      };

      function settingsManager(config) {
        return {
          activeTab: 'ai',
          activeProvider: config.initialProvider || 'default',
          usePersonal: config.initialUsePersonal,
          cloudModels: config.initialCloudModels,
          storedModel: config.initialModel,
          
          ollama: {
            connected: false,
            models: [],
            loading: false,
            selectedModel: config.initialProvider === 'ollama' ? config.initialModel : ''
          },
          showHelp: false,

          async init() {
            if (this.activeProvider === 'ollama') await this.checkOllama();
            
            this.$watch('usePersonal', val => {
              if (!val && (this.activeProvider === 'gemini' || this.activeProvider === 'openrouter')) {
                this.activeProvider = 'default';
              }
            });
          },

          async checkOllama() {
            this.ollama.loading = true;
            try {
              const res = await fetch('http://localhost:11434/api/tags');
              if (res.ok) {
                const data = await res.json();
                this.ollama.models = data.models.map(m => m.name);
                this.ollama.connected = true;
                if (!this.ollama.selectedModel && this.ollama.models.length > 0) {
                  this.ollama.selectedModel = this.ollama.models[0];
                }
              }
            } catch (e) {
              this.ollama.connected = false;
            } finally {
              this.ollama.loading = false;
            }
          },

          async testKey(provider, key) {
            if (!key) return alert('Entrez une cl√© d\'abord.');
            const btn = event.currentTarget;
            btn.innerText = '‚è≥...';
            try {
              const res = await fetch('/settings/test-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': config.csrfToken },
                body: JSON.stringify({ provider, key })
              });
              const data = await res.json();
              if (res.ok) {
                alert('‚úÖ Cl√© valide ! Mod√®les charg√©s.');
                this.cloudModels = data.models;
                this.activeProvider = provider;
                this.usePersonal = true;
              } else {
                alert('‚ùå ' + data.message);
              }
            } catch (e) {
              alert('‚ùå Erreur de connexion');
            } finally {
              btn.innerText = 'V√©rifier & Charger';
            }
          }
        }
      }
    </script>

    <main class="max-w-7xl mx-auto px-6 py-12" x-data="settingsManager(settingsConfig)">
      
      <div class="mb-12">
        <h1 class="text-4xl font-black text-slate-900 mb-2 italic">Param√®tres Premium</h1>
        <p class="text-slate-500">G√©rez vos sources d'intelligence et vos cl√©s API.</p>
      </div>

      <div class="flex flex-col lg:flex-row gap-10">
        {{-- Sidebar --}}
        <aside class="w-full lg:w-64">
           <nav class="space-y-2">
              <button @click="activeTab = 'ai'" :class="activeTab === 'ai' ? 'bg-primary-600 text-white shadow-lg shadow-primary-200' : 'bg-white text-slate-600 hover:bg-slate-50'" class="w-full flex items-center gap-3 px-6 py-4 rounded-2xl font-bold transition-all">ü§ñ Moteur IA</button>
              <button @click="activeTab = 'profile'" :class="activeTab === 'profile' ? 'bg-primary-600 text-white shadow-lg shadow-primary-200' : 'bg-white text-slate-600 hover:bg-slate-50'" class="w-full flex items-center gap-3 px-6 py-4 rounded-2xl font-bold transition-all">üë§ Mon Profil</button>
              <button @click="activeTab = 'security'" :class="activeTab === 'security' ? 'bg-primary-600 text-white shadow-lg shadow-primary-200' : 'bg-white text-slate-600 hover:bg-slate-50'" class="w-full flex items-center gap-3 px-6 py-4 rounded-2xl font-bold transition-all">üîí S√©curit√©</button>
           </nav>
        </aside>

        {{-- Content --}}
        <div class="flex-1">
          
          {{-- PILLIERS IA --}}
          <div x-show="activeTab === 'ai'" class="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <form action="/settings" method="POST" class="space-y-8">
              {{ csrfField() }}
              
              {{-- On stocke le mod√®le choisi --}}
              <input type="hidden" name="ai_model" :value="activeProvider === 'ollama' ? ollama.selectedModel : storedModel">

              <h2 class="text-sm font-black text-slate-400 uppercase tracking-widest mb-6 px-2">1. Choisissez votre source d'intelligence</h2>
              
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                 {{-- PILLIER 1 : ADMIN --}}
                 <div class="relative group">
                    <input type="radio" name="ai_provider" id="p_default" value="default" x-model="activeProvider" @click="usePersonal = false" class="peer hidden">
                    <label for="p_default" class="block h-full cursor-pointer rounded-[2rem] border-2 border-slate-100 p-8 transition-all hover:border-primary-200 peer-checked:border-primary-600 peer-checked:bg-primary-50 peer-checked:shadow-xl">
                       <span class="text-xs font-black px-2 py-1 bg-slate-900 text-white rounded-lg mb-4 inline-block tracking-tighter">STANDARD</span>
                       <div class="text-4xl mb-4">üè†</div>
                       <h3 class="text-lg font-bold text-slate-900 mb-2">Cl√© du Serveur</h3>
                       <p class="text-xs text-slate-500 leading-relaxed italic">Utilise les quotas de l'administrateur (Gemini par d√©faut).</p>
                    </label>
                 </div>

                 {{-- PILLIER 2 : PERSONNEL --}}
                 <div class="relative group">
                    <input type="radio" name="ai_provider" id="p_custom" value="gemini" x-model="activeProvider" @click="usePersonal = true" class="peer hidden" :checked="usePersonal">
                    <label for="p_custom" class="block h-full cursor-pointer rounded-[2rem] border-2 border-slate-100 p-8 transition-all hover:border-indigo-200 peer-checked:border-indigo-600 peer-checked:bg-indigo-50 peer-checked:shadow-xl">
                       <span class="text-xs font-black px-2 py-1 bg-indigo-600 text-white rounded-lg mb-4 inline-block tracking-tighter">PREMIUM</span>
                       <div class="text-4xl mb-4">üîë</div>
                       <h3 class="text-lg font-bold text-slate-900 mb-2">Mes cl√©s API</h3>
                       <p class="text-xs text-slate-500 leading-relaxed italic">Utilisez vos propres acc√®s (Gemini ou OpenRouter) sans limites.</p>
                    </label>
                 </div>

                 {{-- PILLIER 3 : OLLAMA --}}
                 <div class="relative group">
                    <input type="radio" name="ai_provider" id="p_ollama" value="ollama" x-model="activeProvider" @click="checkOllama(); usePersonal = false" class="peer hidden">
                    <label for="p_ollama" class="block h-full cursor-pointer rounded-[2rem] border-2 border-slate-100 p-8 transition-all hover:border-orange-200 peer-checked:border-orange-600 peer-checked:bg-orange-50 peer-checked:shadow-xl">
                       <span class="text-xs font-black px-2 py-1 bg-orange-600 text-white rounded-lg mb-4 inline-block tracking-tighter">LOCAL</span>
                       <div class="text-4xl mb-4">ü¶ô</div>
                       <h3 class="text-lg font-bold text-slate-900 mb-2">Ollama (PC)</h3>
                       <p class="text-xs text-slate-500 leading-relaxed italic">G√©rez vos cours gratuitement sur votre machine. 100% priv√©.</p>
                    </label>
                 </div>
              </div>

              {{-- CONFIGURATION CONDITIONNELLE --}}
              <div class="space-y-6">
                
                {{-- Sous-choix pour le mode Personnel --}}
                <div x-show="usePersonal || (activeProvider !== 'default' && activeProvider !== 'ollama')" class="bg-white rounded-[2.5rem] p-8 border border-slate-200 shadow-sm animate-in zoom-in-95 duration-300">
                   <div class="flex items-center gap-4 mb-8">
                      <input type="checkbox" name="use_custom_keys" x-model="usePersonal" class="w-6 h-6 text-primary-600 rounded-lg">
                      <label class="font-black text-slate-800 tracking-tight">Activer l'utilisation de mes cl√©s</label>
                   </div>
                   
                   <div class="grid grid-cols-1 md:grid-cols-2 gap-8" x-show="usePersonal">
                      <div class="space-y-4">
                         <label class="block text-xs font-black text-slate-400 uppercase tracking-widest">Choisir mon moteur</label>
                         <select x-model="activeProvider" name="ai_provider_sub" class="w-full p-4 rounded-xl bg-slate-50 border-none font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="gemini">‚ú® Google Gemini (Recommand√©)</option>
                            <option value="openrouter">üåê OpenRouter (Multi-mod√®les)</option>
                         </select>
                      </div>

                      <div class="space-y-4">
                        <label class="block text-xs font-black text-slate-400 uppercase tracking-widest">Ma cl√© API</label>
                        <div x-show="activeProvider === 'gemini'">
                           <div class="flex gap-2">
                              <input type="password" name="custom_gemini_key" value="{{ user.customGeminiKey || '' }}" x-ref="gKey" class="flex-1 p-4 rounded-xl bg-slate-50 border-none font-mono text-sm shadow-inner" placeholder="Pousser ici votre cl√© Gemini">
                              <button type="button" @click="testKey('gemini', $refs.gKey.value)" class="px-4 bg-slate-900 text-white rounded-xl font-bold text-xs">V√©rifier</button>
                           </div>
                        </div>
                        <div x-show="activeProvider === 'openrouter'">
                           <div class="flex gap-2">
                              <input type="password" name="custom_openrouter_key" value="{{ user.customOpenrouterKey || '' }}" x-ref="oKey" class="flex-1 p-4 rounded-xl bg-slate-50 border-none font-mono text-sm shadow-inner" placeholder="Votre cl√© OpenRouter">
                              <button type="button" @click="testKey('openrouter', $refs.oKey.value)" class="px-4 bg-slate-900 text-white rounded-xl font-bold text-xs">V√©rifier</button>
                           </div>
                        </div>
                      </div>
                   </div>
                </div>

                {{-- S√âLECTEUR DE MOD√àLE (TOUJOURS L√Ä POUR CLOUD) --}}
                <div x-show="activeProvider !== 'ollama'" class="bg-slate-900 text-white rounded-[2.5rem] p-10 shadow-2xl">
                   <div class="flex flex-col md:flex-row gap-10 items-center">
                      <div class="flex-1 space-y-4">
                        <h4 class="text-xs font-black text-primary-400 uppercase tracking-widest">2. Choix du cerveau sp√©cifique</h4>
                        <p class="text-slate-400 text-sm">S√©lectionnez le mod√®le exact que vous souhaitez utiliser.</p>
                        <select x-model="storedModel" class="w-full bg-slate-800 border-none text-white p-5 rounded-2xl outline-none focus:ring-2 focus:ring-primary-500 font-mono text-sm">
                           <template x-for="m in cloudModels" :key="m">
                              <option :value="m" x-text="m" :selected="storedModel === m"></option>
                           </template>
                        </select>
                      </div>
                      <div class="max-w-[200px] text-xs text-slate-500 leading-relaxed px-6 border-l border-slate-800">
                         üí° <strong>Tip:</strong> Les mod√®les affich√©s d√©pendent du moteur choisi ci-dessus (Standard ou Personnel).
                      </div>
                   </div>
                </div>

                {{-- PANNEAU OLLAMA --}}
                <div x-show="activeProvider === 'ollama'" class="bg-orange-50 border-2 border-orange-200 rounded-[2.5rem] p-10 space-y-6 overflow-hidden relative">
                   <div class="flex items-center justify-between">
                      <h4 class="font-black text-orange-900 text-xl italic">Param√®tres Ollama</h4>
                      <div :class="ollama.connected ? 'bg-emerald-500' : 'bg-red-500'" class="px-4 py-1 text-white text-[10px] font-black rounded-full uppercase" x-text="ollama.connected ? 'Connect√©' : 'Hors-ligne'"></div>
                   </div>
                   
                   <div x-show="!ollama.connected" class="p-6 bg-white rounded-2xl border border-orange-100 space-y-4 shadow-sm relative z-10">
                      <p class="text-sm text-orange-800 font-bold leading-relaxed">‚ö†Ô∏è Ollama n'est pas d√©tect√© sur votre machine (localhost:11434).</p>
                      <div class="flex flex-wrap gap-3 mt-4">
                         <button type="button" @click="checkOllama()" class="bg-slate-900 text-white px-6 py-2 rounded-xl font-bold text-xs hover:bg-slate-800 transition-colors">R√©essayer la d√©tection</button>
                         <button type="button" @click="showHelp = true" class="bg-orange-600 text-white px-6 py-2 rounded-xl font-bold text-xs hover:bg-orange-700 transition-colors shadow-lg shadow-orange-200">Comment le configurer ?</button>
                      </div>
                   </div>

                   <div x-show="ollama.connected" class="space-y-4 animate-in zoom-in-95 duration-300">
                      <label class="block text-xs font-black text-orange-900 uppercase tracking-widest">Mod√®le d√©tect√© sur votre PC</label>
                      <select x-model="ollama.selectedModel" class="w-full p-4 rounded-xl bg-white border-orange-200 text-slate-800 font-bold outline-none focus:ring-2 focus:ring-orange-500">
                         <template x-for="m in ollama.models" :key="m">
                            <option :value="m" x-text="m"></option>
                         </template>
                      </select>
                      <p class="text-[10px] text-orange-600 italic">‚ú® Ollama utilise uniquement la puissance de votre propre ordinateur.</p>
                   </div>
                </div>

              </div>

              <div class="flex justify-end pt-6">
                <button type="submit" class="bg-primary-600 text-white text-base font-black py-5 px-5 rounded-[2rem] shadow-xl hover:bg-primary-700 hover:-translate-y-1 transition-all active:translate-y-0 text-xl tracking-tight">
                  Enregistrer ma configuration IA
                </button>
              </div>
            </form>

            {{-- MODAL D'AIDE OLLAMA --}}
            <div x-show="showHelp" 
                 x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                 class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm" style="display: none;">
              
              <div @click.away="showHelp = false" class="bg-white rounded-[3rem] p-10 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl space-y-8">
                 <div class="flex justify-between items-start">
                    <div class="flex items-center gap-4">
                       <div class="p-4 bg-orange-100 text-orange-600 rounded-2xl text-2xl">‚öôÔ∏è</div>
                       <h2 class="text-3xl font-black text-slate-900 italic tracking-tight">Aide Ollama</h2>
                    </div>
                    <button @click="showHelp = false" class="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-400">
                       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                 </div>

                 <div class="space-y-6 text-slate-600 leading-relaxed">
                    <div class="p-5 bg-slate-50 rounded-2xl border border-slate-100">
                       <p class="font-bold text-slate-800 text-sm mb-2 italic">Probl√®me de connexion ?</p>
                       <p class="text-xs">Le navigateur bloque les acc√®s vers Ollama pour des raisons de s√©curit√© (CORS). Vous devez autoriser <strong>My Professor</strong> en configurant une variable d'environnement.</p>
                    </div>

                    <div class="space-y-6">
                       {{-- Windows --}}
                       <div class="space-y-2">
                          <p class="font-black text-slate-800 text-[10px] uppercase tracking-widest flex items-center gap-2">ü™ü Windows (OLLAMA_ORIGINS)</p>
                          <p class="text-xs">Fermez Ollama, cherchez "Variables d'environnement" dans Windows, ajoutez une variable syst√®me <strong>OLLAMA_ORIGINS</strong> avec la valeur <code>*</code>, puis relancez Ollama.</p>
                       </div>

                       {{-- Linux --}}
                       <div class="space-y-2">
                          <p class="font-black text-slate-800 text-[10px] uppercase tracking-widest flex items-center gap-2">üêß Linux (Service)</p>
                          <div class="bg-dark p-4 rounded-xl font-mono text-[10px] text-slate-300">
                             sudo systemctl edit ollama.service<br><br>
                             # Ajoutez sous [Service]:<br>
                             Environment="OLLAMA_ORIGINS=*"
                          </div>
                       </div>

                       {{-- MacOS --}}
                       <div class="space-y-2">
                          <p class="font-black text-slate-800 text-[10px] uppercase tracking-widest flex items-center gap-2">üçé MacOS (Terminal)</p>
                          <div class="bg-dark p-4 rounded-xl font-mono text-[10px] text-slate-300">
                             launchctl setenv OLLAMA_ORIGINS "*"
                          </div>
                       </div>
                    </div>
                 </div>

                 <div class="pt-4 flex justify-end">
                    <button @click="showHelp = false; checkOllama()" class="bg-primary-600 text-white font-black py-4 px-10 rounded-2xl shadow-xl hover:bg-primary-700 transition-all">J'ai configur√©, actualiser</button>
                 </div>
              </div>
            </div>
          </div>

          {{-- PROFIL --}}
          <div x-show="activeTab === 'profile'" class="bg-white rounded-[3rem] p-10 shadow-sm border border-slate-100">
            <h2 class="text-2xl font-black mb-8">Informations personnelles</h2>
            <form action="/settings/profile" method="POST" class="space-y-6">
               {{ csrfField() }}
               <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div>
                    <label class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Nom complet</label>
                    <input type="text" name="fullName" value="{{ user.fullName }}" class="w-full p-4 rounded-xl bg-slate-50 border-none font-bold text-slate-700">
                 </div>
                 <div>
                    <label class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Email</label>
                    <input type="email" value="{{ user.email }}" readonly class="w-full p-4 rounded-xl bg-slate-100 border-none text-slate-400 cursor-not-allowed">
                 </div>
               </div>
               <div class="flex justify-end">
                 <button type="submit" class="bg-slate-900 text-white font-black py-4 px-8 rounded-2xl shadow-lg">Mettre √† jour</button>
               </div>
            </form>
          </div>

          {{-- S√âCURIT√â --}}
          <div x-show="activeTab === 'security'" class="bg-white rounded-[3rem] p-10 shadow-sm border border-slate-100">
            <h2 class="text-2xl font-black mb-8">S√©curit√© du compte</h2>
            <form action="/settings/password" method="POST" class="space-y-6">
               {{ csrfField() }}
               <div>
                  <label class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Mot de passe actuel</label>
                  <input type="password" name="current_password" required class="w-full p-4 rounded-xl bg-slate-50 border-none">
               </div>
               <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div>
                    <label class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Nouveau mot de passe</label>
                    <input type="password" name="new_password" required class="w-full p-4 rounded-xl bg-slate-50 border-none">
                 </div>
                 <div>
                    <label class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Confirmer le nouveau</label>
                    <input type="password" name="new_password_confirmation" required class="w-full p-4 rounded-xl bg-slate-50 border-none">
                 </div>
               </div>
               <div class="flex justify-end">
                 <button type="submit" class="bg-rose-600 text-white font-black py-4 px-8 rounded-2xl shadow-lg">Changer le mot de passe</button>
               </div>
            </form>
          </div>

        </div>
      </div>
    </main>
@end
@end